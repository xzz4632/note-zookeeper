## 《从Paxos到ZooKeeper》读书笔记

### 第一章 分布式构架

###### 001 分布式系统的概念

分布式系统是指一个硬件或软件组件分布在不同的计算机上，彼此之间仅仅通过消息传递进行通信和协调的系统。



###### 002 分布式系统的特点

- 分布性：多台计算机在空间上的随意分布。
- 对等性：没有主从之分。
- 并发性：并发操作某些资源。
- 缺乏全局时钟：很难定义先后。
- 总全发生故障



###### 003 分布式环境的常见问题

- 网络通信异常
- 节点故障



###### 004 ACID

- A： 原子性
- C：一致性
- I：隔离性
- D：持久性



###### 005 事务的隔离级别

- 读未提交
- 读已提交
- 可重复读
- 串行



###### 006 CAP理论

- C：一致性

- A：可用性

- P：分区容错性

  一个分布式系统不可能同时满足以上三个需求，而分区容错是分布式系统的基本要求，因此在设计时需要在C和A之间寻求平衡。

###### 007 BASE理论

- BA：Basically Available 基本可用，在系统出现故障时，允许损失部分性：如响应时间上的损失，功能上的损失（部分功能可用）。
- S：Soft state 软状态，数据存在中间状态，而此状态不会影响事体系统的可用性。
- E：Eventually consistent 最终一致性，经过一段时间的处理后，数据最终达到一致性。



### 第2章 一致性协议

一致性协议是指在事务处理过程中保证原子性和一致性的算法。

###### 008 2PC

2PC即为Two-Phase Commit，两阶段提交。即将事务的提交分为两个阶段来处理。

- 阶段一：提交事务请求
  - 协调者向所有的参与者发送事务内容，询问是否可以执行事务提交操作，并开始等待各参与者的响应。
  - 执行事务：各参与者执行事务操作，并记录Undo和Redo日志。
  - 各参与者向协调者反馈事务的执行情况：如果成功执行事务则返回Yes,否则返回No。
- 阶段二：执行事务提交
  - 执行事务提交（所有参与者返回Yes）：协调者向所有参与者发送Commit请求；参与者执行事务提交操作，并释放资源；参与者向协调者反馈事务提交结果；协调者收到反馈消息后，完成事务。
  - 中断事务（任意参与者返回No）：协调者向所有参与者发出Rollback请求；参与者接收到回滚请求后，利用Undo信息执行回滚操作，完成后释放资源；参与者向协调者反馈结果；协调者完成事务中断。

2PC的优点是原理简单，实现方便。缺点如下：

- 同步阻塞： 极大地限制了分布式系统的性能。
- 单点问题：一旦协调者出现问题，第二阶段提交流量将无法运转。如果问题出现阶段二第一步，则可能导致参与者锁定的资源无法释放。
- 数据不一致：如果只有部分参与者收到Commit请求，因此只会有部分参与者提交了事务。

###### 009 3PC

3PC即为三阶段提交。将2PC的阶段一分成了两个阶段，即CanCommit，PreCommit，doCommit三个阶段。

- 阶段一：CanCommit 